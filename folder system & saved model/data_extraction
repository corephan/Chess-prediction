%%writefile /content/ChessOutcomesPrediction/System/data_extraction.py
import chess.pgn
import os
import time

def extract_all_draws(source_folder, source_files, output_filename):
    """
    H√†m ƒë·ªçc danh s√°ch c√°c file PGN, l·ªçc v√°n ho√† v√† ghi v√†o 1 file duy nh·∫•t.
    """
    output_path = os.path.join(source_folder, output_filename)

    if os.path.exists(output_path):
        os.remove(output_path)
        print(f"üóëÔ∏è ƒê√£ xo√° file c≈©: {output_filename}")

    total_draws = 0
    start_time = time.time()

    print(f"üöÄ B·∫ÆT ƒê·∫¶U EXTRACT DRAW T·ª™ {len(source_files)} FILE...")
    print("-" * 60)

    with open(output_path, 'w', encoding='utf-8') as pgn_out:

        for filename in source_files:
            file_path = os.path.join(source_folder, filename)

            if not os.path.exists(file_path):
                print(f"‚ö†Ô∏è C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y file {filename}. B·ªè qua.")
                continue

            print(f"üìÇ ƒêang x·ª≠ l√Ω: {filename} ...")

            with open(file_path, 'r', encoding='utf-8') as pgn_in:
                file_draws = 0
                game_count = 0

                while True:
                    try:
                        game = chess.pgn.read_game(pgn_in)
                    except Exception as e:
                        continue

                    if game is None:
                        break

                    game_count += 1

                    result = game.headers.get("Result", "*")
                    if result == "1/2-1/2":
                        print(game, file=pgn_out, end="\n\n")
                        file_draws += 1
                        total_draws += 1

                        if file_draws % 1000 == 0:
                            print(f"   -> ƒê√£ t√¨m th·∫•y {file_draws} v√°n ho√† trong file n√†y...", end='\r')

            print(f"‚úÖ Xong file {filename}. T√¨m th·∫•y: {file_draws} v√°n ho√†.")

    duration = time.time() - start_time
    print("-" * 60)
    print(f"üéâ HO√ÄN T·∫§T!")
    print(f"üìä T·ªïng s·ªë v√°n ho√† thu ƒë∆∞·ª£c: {total_draws}")
    print(f"üíæ File l∆∞u t·∫°i: {output_path}")
    print(f"‚è±Ô∏è Th·ªùi gian ch·∫°y: {duration:.2f} gi√¢y")

# --- C·∫§U H√åNH & CH·∫†Y ---
# if __name__ == "__main__":
#     BASE_DIR = "/content/ChessOutcomesPrediction/DataSets/pgnData"
#     if not os.path.exists(BASE_DIR):
#         print(f"‚ùå Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c: {BASE_DIR}")
#         exit(1)
#     OUTPUT_FILE = 'all_draws_combined.pgn'
#     all_pgn_files_in_dir = [f for f in os.listdir(BASE_DIR) if f.endswith('.pgn')]
#     source_files_to_process = [f for f in all_pgn_files_in_dir if f != OUTPUT_FILE]
#     if len(source_files_to_process) == 0:
#         print(f"‚ùå Kh√¥ng t√¨m th·∫•y file .pgn n√†o ƒë·ªÉ x·ª≠ l√Ω trong th∆∞ m·ª•c: {BASE_DIR} (ngo·∫°i tr·ª´ {OUTPUT_FILE} n·∫øu c√≥).")
#         exit(1)
#     SOURCE_FILES = sorted(source_files_to_process)[:3]
#     print(f"üìÅ Th∆∞ m·ª•c: {BASE_DIR}")
#     print(f"üìÑ Files ƒë∆∞·ª£c x·ª≠ l√Ω: {SOURCE_FILES}")
#     extract_all_draws(BASE_DIR, SOURCE_FILES, OUTPUT_FILE)
